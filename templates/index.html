<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synapse Run</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <!-- Google Fonts - 更好的字体渲染 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 主色调 - 现代深空蓝主题 */
            --bg-dark: #0a0f1a;
            --bg-panel: #111827;
            --bg-elevated: #1f2937;
            --bg-hover: #374151;

            /* 边框和分隔线 */
            --border: rgba(255, 255, 255, 0.08);
            --border-focus: rgba(0, 78, 137, 0.5);

            /* 主题色 - 蓝绿渐变 */
            --primary: #004E89;
            --primary-light: #72B01D;
            --primary-dark: #003A63;
            --primary-dim: rgba(0, 78, 137, 0.15);
            --primary-glow: rgba(0, 78, 137, 0.4);

            /* 功能色 */
            --success: #10b981;
            --success-dim: rgba(16, 185, 129, 0.15);
            --warning: #f59e0b;
            --warning-dim: rgba(245, 158, 11, 0.15);
            --error: #ef4444;
            --error-dim: rgba(239, 68, 68, 0.15);
            --info: #3b82f6;

            /* 文字色 */
            --text-main: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --text-inverse: #111827;

            /* 字体 */
            --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', Consolas, monospace;

            /* 阴影 */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 20px var(--primary-glow);

            /* 圆角 */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --radius-full: 9999px;

            /* 过渡 */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 400ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: var(--radius-full);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-dark);
            color: var(--text-main);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== 顶部导航栏 ===== */
        .search-section {
            height: 70px;
            background: linear-gradient(180deg, rgba(17, 24, 39, 0.98) 0%, rgba(17, 24, 39, 0.95) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 28px;
            justify-content: space-between;
            z-index: 100;
            position: relative;
        }

        .search-title {
            display: flex;
            align-items: center;
            gap: 14px;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
            color: var(--text-main);
        }

        .brand-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #004E89 0%, #72B01D 100%);
            border-radius: var(--radius-md);
            display: grid;
            place-items: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .brand-logo::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
        }

        .search-box {
            display: flex;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 4px;
            width: 520px;
            transition: all var(--transition-normal);
            position: relative;
        }

        .search-box:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-dim), var(--shadow-glow);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-main);
            padding: 12px 16px;
            font-family: var(--font-sans);
            font-size: 14px;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-button {
            background: linear-gradient(135deg, #004E89 0%, #72B01D 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }

        .search-button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md), var(--shadow-glow);
        }

        .search-button:active {
            transform: translateY(0);
        }

        .search-button:disabled {
            background: var(--bg-hover);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .upload-button {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .upload-button:hover {
            background: var(--bg-hover);
            color: var(--text-main);
            border-color: var(--border-focus);
        }

        .upload-button input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-status {
            font-size: 12px;
            color: var(--text-muted);
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .upload-status.success {
            color: var(--success);
            background: var(--success-dim);
        }

        .upload-status.error {
            color: var(--error);
            background: var(--error-dim);
        }

        /* ===== 主内容区域 ===== */
        .main-content {
            flex: 1;
            display: flex;
            height: calc(100vh - 102px);
            min-height: 0;
        }

        /* ===== 嵌入页面区域 ===== */
        .embedded-section {
            flex: 1.8;
            border-right: 1px solid var(--border);
            background: linear-gradient(180deg, var(--bg-dark) 0%, rgba(17, 24, 39, 0.5) 100%);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .embedded-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .embedded-header::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--success);
        }

        .embedded-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* ===== 控制台输出区域 ===== */
        .console-section {
            flex: 1.2;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            min-height: 0;
            overflow: hidden;
        }

        /* Agent选项卡切换 */
        .app-switcher {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
            padding: 0 4px;
        }

        .app-button {
            flex: 1;
            padding: 14px 16px;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all var(--transition-fast);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .app-button:hover:not(.locked) {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.02);
        }

        .app-button.active {
            color: var(--primary-light);
            border-bottom-color: var(--primary);
        }

        .app-button.locked {
            color: var(--text-muted);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            box-shadow: 0 0 6px var(--error);
            transition: all var(--transition-fast);
        }

        .status-indicator.running {
            background: var(--success);
            box-shadow: 0 0 8px var(--success);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .status-indicator.starting {
            background: var(--warning);
            box-shadow: 0 0 6px var(--warning);
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* ===== 控制台终端样式 ===== */
        .console-output {
            flex: 1;
            padding: 20px;
            background: linear-gradient(145deg, #0c1222 0%, #0f172a 50%, #0c1222 100%);
            color: #e0f2ff;
            font-family: var(--font-mono);
            font-size: 13px;
            overflow-y: auto;
            overflow-x: hidden;
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 0;
            position: relative;
            line-height: 1.8;
            border: 1px solid rgba(0, 78, 137, 0.2);
        }

        /* 终端网格背景 */
        .console-output::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(90deg, rgba(0, 78, 137, 0.02) 1px, transparent 1px),
                linear-gradient(rgba(0, 78, 137, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: 1;
        }

        .console-line {
            margin-bottom: 6px;
            opacity: 0;
            animation: slideIn 0.25s ease-out forwards;
            position: relative;
            padding-left: 24px;
            z-index: 2;
        }

        .console-line::before {
            content: '>';
            position: absolute;
            left: 0;
            color: var(--primary-light);
            font-weight: 600;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-8px);
            }
            to {
                opacity: 0.95;
                transform: translateX(0);
            }
        }

        /* ===== 状态栏 ===== */
        .status-bar {
            height: 32px;
            padding: 0 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
        }

        /* ===== 加载动画 ===== */
        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .report-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--warning);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== 任务进度条 ===== */
        .task-progress-container {
            padding: 20px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }

        .task-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-main);
        }

        .task-progress-title {
            display: flex;
            align-items: center;
        }

        .task-progress-bar {
            width: 200px;
            height: 24px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: var(--radius-full);
            position: relative;
            overflow: hidden;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #004E89 0%, #72B01D 100%);
            border-radius: var(--radius-full);
            transition: width 0.4s ease;
            box-shadow: 0 0 12px var(--primary-glow);
        }

        .task-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-main);
            font-weight: 700;
            font-size: 11px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        .task-info-line {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 12px;
            padding: 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 12px;
        }

        .task-info-item {
            display: flex;
            align-items: center;
        }

        .task-info-label {
            font-weight: 600;
            color: var(--text-muted);
            margin-right: 8px;
        }

        .task-info-value {
            color: var(--text-secondary);
        }

        .task-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .task-status-running {
            background: var(--warning-dim);
            color: var(--warning);
        }

        .task-status-completed {
            background: var(--success-dim);
            color: var(--success);
        }

        .task-status-error {
            background: var(--error-dim);
            color: var(--error);
        }

        .task-error-message {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--error-dim);
            border-left: 3px solid var(--error);
            border-radius: var(--radius-sm);
            font-size: 13px;
            color: var(--error);
        }

        /* ===== 消息提示 ===== */
        .message {
            position: fixed;
            top: 86px;
            right: 28px;
            padding: 14px 24px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-main);
            font-weight: 500;
            font-size: 14px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateX(calc(100% + 28px));
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            backdrop-filter: blur(12px);
        }

        .message.show {
            transform: translateX(0);
        }

        .message.success {
            border-color: var(--success);
            background: var(--success-dim);
            color: var(--success);
        }

        .message.error {
            border-color: var(--error);
            background: var(--error-dim);
            color: var(--error);
        }

        /* ===== Forum Engine 样式 ===== */
        .forum-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .forum-container.active {
            display: flex;
        }

        .forum-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-dark);
            gap: 16px;
        }

        .forum-message {
            max-width: 90%;
            padding: 16px 20px;
            border-radius: var(--radius-md);
            word-wrap: break-word;
            position: relative;
            transition: transform var(--transition-fast);
        }

        .forum-message:hover {
            transform: translateY(-1px);
        }

        .forum-message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #004E89 0%, #72B01D 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .forum-message.system {
            align-self: flex-start;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .forum-message.agent {
            align-self: stretch;
            width: 100%;
            background: white;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            box-shadow: var(--shadow-sm);
        }

        /* Agent 卡片颜色 */
        .forum-message.query-engine {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: #38bdf8;
        }

        .forum-message.insight-engine {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #a855f7;
        }

        .forum-message.media-engine {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #22c55e;
        }

        .forum-message.host {
            align-self: stretch;
            width: 100%;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-color: #f59e0b;
            color: #78350f;
            font-style: italic;
        }

        .forum-message-header {
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 13px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .forum-message-content {
            line-height: 1.7;
            white-space: pre-wrap;
            overflow-wrap: break-word;
            font-size: 14px;
        }

        .forum-timestamp {
            font-size: 11px;
            opacity: 0.5;
            margin-top: 8px;
        }

        /* ===== Report Engine 样式 ===== */
        .report-container {
            display: none;
            height: 100%;
            flex-direction: column;
            position: relative;
        }

        .report-container.active {
            display: flex;
        }

        .report-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .report-status {
            padding: 16px 20px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            font-family: var(--font-mono);
            font-size: 13px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
        }

        .report-status.loading {
            border-color: var(--warning);
            background: var(--warning-dim);
        }

        .report-status.success {
            border-color: var(--success);
            background: var(--success-dim);
        }

        .report-status.error {
            border-color: var(--error);
            background: var(--error-dim);
        }

        .report-preview {
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            min-height: 400px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .report-preview iframe {
            width: 100%;
            min-height: 600px;
            height: 100%;
            border: none;
            flex: 1;
        }

        .report-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* ===== 响应式设计 ===== */
        @media (max-width: 1200px) {
            .search-box {
                width: 400px;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }

            .embedded-section {
                border-right: none;
                border-bottom: 1px solid var(--border);
                height: 50vh;
            }

            .console-section {
                height: 50vh;
            }

            .search-box {
                width: 100%;
                max-width: 300px;
            }

            .app-button {
                padding: 12px 8px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 顶部导航栏 -->
        <div class="search-section">
            <div class="search-title">
                <div class="brand-logo">S</div>
                Synapse Run
            </div>

            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="请输入训练问题或数据分析需求...">
            </div>

            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="upload-button" id="uploadButton">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    上传模板
                    <input type="file" id="templateFileInput" accept=".md,.txt" title="上传自定义报告模板">
                </button>
                <button class="search-button" id="searchButton">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    开始运行
                </button>
            </div>
        </div>
        <div class="upload-status" id="uploadStatus" style="position: absolute; top: 76px; right: 28px;"></div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 嵌入页面区域 -->
            <div class="embedded-section">
                <div class="embedded-header" id="embeddedHeader">多智能体协作平台</div>
                <div class="embedded-content" id="embeddedContent">
                    <!-- 论坛聊天界面 -->
                    <div class="forum-container" id="forumContainer">
                        <div class="forum-chat-area" id="forumChatArea">
                        </div>
                    </div>

                    <!-- 报告引擎界面 -->
                    <div class="report-container" id="reportContainer">
                        <div class="report-content" id="reportContent">
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); flex-direction: column; gap: 12px;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <span>点击上方按钮切换智能体视图</span>
                    </div>
                </div>
            </div>

            <!-- 控制台输出区域 -->
            <div class="console-section">
                <!-- 应用切换按钮 -->
                <div class="app-switcher">
                    <button class="app-button active" data-app="insight">
                        <span class="status-indicator" id="status-insight"></span>
                        运动科学家
                    </button>
                    <button class="app-button" data-app="media">
                        <span class="status-indicator" id="status-media"></span>
                        后勤与情报官
                    </button>
                    <button class="app-button" data-app="query">
                        <span class="status-indicator" id="status-query"></span>
                        理论专家
                    </button>
                    <button class="app-button" data-app="forum">
                        <span class="status-indicator running" id="status-forum"></span>
                        总教练
                    </button>
                    <button class="app-button locked" data-app="report" title="需等待其余三个Agent工作完毕">
                        <span class="status-indicator" id="status-report"></span>
                        训练秘书
                    </button>
                </div>

                <!-- 控制台输出 -->
                <div class="console-output" id="consoleOutput">
                    <div class="console-line">[系统] 等待连接...</div>
                </div>
            </div>
        </div>

        <!-- 状态栏 -->
        <div class="status-bar">
            <span id="connectionStatus">连接中...</span>
            <span id="systemTime"></span>
        </div>
    </div>

    <!-- 消息提示 -->
    <div class="message" id="message"></div>

    <script>
        // 全局变量
        let socket;
        let currentApp = 'insight';
        let appStatus = {
            insight: 'stopped',
            media: 'stopped',
            query: 'stopped',
            forum: 'running',
            report: 'stopped'
        };
        let customTemplate = '';

        // 应用名称映射
        const appNames = {
            insight: '运动科学家',
            media: '后勤与情报官',
            query: '理论专家',
            forum: '总教练',
            report: '训练秘书'
        };

        // 页面头部显示的完整Agent介绍
        const agentTitles = {
            insight: '运动科学家 - 生理数据量化分析 · 循证训练建议',
            media: '后勤与情报官 - 比赛报名 · 天气预报 · 装备价格 · 路线坡度',
            query: '理论专家 - 训练理论研究 · 学术文献检索',
            forum: '总教练 - 多智能体协同 · 训练方案统筹',
            report: '训练秘书 - 报告生成汇总 · 数据可视化呈现'
        };

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeEventListeners();
            updateTime();
            setInterval(updateTime, 1000);
            checkStatus();
            setInterval(checkStatus, 5000);

            checkReportLockStatus();
            reportLockCheckInterval = setInterval(checkReportLockStatus, 10000);

            setInterval(() => refreshConsoleOutput(), 1000);
            setInterval(() => refreshForumMessages(), 2000);

            initializeForum();
            setTimeout(() => preloadIframes(), 3000);
        });

        // Socket.IO连接
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus('已连接');
                socket.emit('request_status');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus('连接断开');
            });

            socket.on('console_output', function(data) {
                if (data.app === currentApp) {
                    addConsoleOutput(data.line);
                }

                if (data.app === 'forum') {
                    const parsed = parseForumMessage(data.line);
                }
            });

            socket.on('forum_message', function(data) {
            });

            socket.on('status_update', function(data) {
                updateAppStatus(data);
            });
        }

        // 事件监听器
        function initializeEventListeners() {
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });

            document.getElementById('templateFileInput').addEventListener('change', handleTemplateUpload);

            document.querySelectorAll('.app-button').forEach(button => {
                button.addEventListener('click', function() {
                    const app = this.dataset.app;
                    switchToApp(app);
                });
            });
        }

        // 执行搜索
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showMessage('请输入训练问题或数据分析需求', 'error');
                return;
            }

            const button = document.getElementById('searchButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> 搜索中...';

            const reportPreview = document.getElementById('reportPreview');
            if (reportPreview) {
                reportPreview.innerHTML = '<div class="report-loading">等待新的搜索结果生成报告...</div>';
            }

            const taskProgressArea = document.getElementById('taskProgressArea');
            if (taskProgressArea) taskProgressArea.innerHTML = '';

            autoGenerateTriggered = false;
            reportTaskId = null;

            if (reportPollingInterval) {
                clearInterval(reportPollingInterval);
                reportPollingInterval = null;
            }

            if (!iframesInitialized) preloadIframes();

            let totalRunning = 0;
            const ports = { insight: 8501, media: 8502, query: 8503 };

            Object.keys(appStatus).forEach(app => {
                if (appStatus[app] === 'running' && preloadedIframes[app]) {
                    totalRunning++;
                    const searchUrl = `http://localhost:${ports[app]}?query=${encodeURIComponent(query)}&auto_search=true`;
                    console.log(`向 ${app} 发送搜索请求: ${searchUrl}`);
                    preloadedIframes[app].src = searchUrl;
                }
            });

            button.disabled = false;
            button.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg> 开始运行';

            if (totalRunning === 0) {
                showMessage('没有运行中的应用，无法执行搜索', 'error');
            } else {
                showMessage(`训练分析请求已发送到 ${totalRunning} 个应用`, 'success');
            }
        }

        // 切换应用
        function switchToApp(app) {
            if (app === currentApp) return;

            if (app === 'report') {
                const reportButton = document.querySelector(`[data-app="report"]`);
                if (reportButton.classList.contains('locked')) {
                    showMessage('需等待其余三个Agent工作完毕', 'error');
                    return;
                }
            }

            document.querySelectorAll('.app-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-app="${app}"]`).classList.add('active');

            currentApp = app;

            if (app === 'forum') {
                document.getElementById('embeddedHeader').textContent = '总教练 - 多智能体协同 · 训练方案统筹';
                document.getElementById('forumContainer').classList.add('active');
                document.getElementById('reportContainer').classList.remove('active');
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[系统] 切换到论坛模式</div>';
                loadForumLog();
            } else if (app === 'report') {
                document.getElementById('embeddedHeader').textContent = '训练秘书 - 报告生成汇总 · 数据可视化呈现';
                document.getElementById('reportContainer').classList.add('active');
                document.getElementById('forumContainer').classList.remove('active');
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[系统] 切换到报告生成模式</div>';
                loadReportLog();

                const reportContent = document.getElementById('reportContent');
                if (!reportContent || reportContent.children.length === 0) {
                    loadReportInterface();
                }

                setTimeout(() => checkReportLockStatus(), 500);
            } else {
                document.getElementById('embeddedHeader').textContent = agentTitles[app] || appNames[app];
                document.getElementById('forumContainer').classList.remove('active');
                document.getElementById('reportContainer').classList.remove('active');
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[系统] 切换到 ' + appNames[app] + '</div>';
                lastLineCount[app] = 0;
                loadConsoleOutput(app);
            }

            updateEmbeddedPage(app);
        }

        let lastLineCount = {};

        function loadConsoleOutput(app) {
            if (app === 'forum') { loadForumLog(); return; }
            if (app === 'report') { loadReportLog(); return; }

            fetch(`/api/output/${app}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.output.length > 0) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    const lastCount = lastLineCount[app] || 0;
                    const newLines = data.output.slice(lastCount);

                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);
                    });

                    lastLineCount[app] = data.output.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => console.error('加载输出失败:', error));
        }

        function refreshConsoleOutput() {
            if (currentApp === 'forum') { refreshForumLog(); return; }
            if (currentApp === 'report') { refreshReportLog(); return; }

            if (appStatus[currentApp] === 'running' || appStatus[currentApp] === 'starting') {
                fetch(`/api/output/${currentApp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.output.length > 0) {
                        const consoleOutput = document.getElementById('consoleOutput');
                        const lastCount = lastLineCount[currentApp] || 0;
                        const newLines = data.output.slice(lastCount);

                        if (newLines.length > 0) {
                            newLines.forEach(line => {
                                const div = document.createElement('div');
                                div.className = 'console-line';
                                div.textContent = line;
                                consoleOutput.appendChild(div);
                            });

                            lastLineCount[currentApp] = data.output.length;
                            consoleOutput.scrollTop = consoleOutput.scrollHeight;
                        }
                    }
                })
                .catch(error => console.error('刷新输出失败:', error));
            }
        }

        function addConsoleOutput(line) {
            const consoleOutput = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = 'console-line';
            div.textContent = line;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        let preloadedIframes = {};
        let iframesInitialized = false;

        function preloadIframes() {
            if (iframesInitialized) return;

            const ports = { insight: 8501, media: 8502, query: 8503 };
            const content = document.getElementById('embeddedContent');

            for (const [app, port] of Object.entries(ports)) {
                const iframe = document.createElement('iframe');
                iframe.src = `http://localhost:${port}`;
                iframe.style.cssText = 'width:100%;height:100%;border:none;position:absolute;top:0;left:0;display:none;';
                iframe.id = `iframe-${app}`;
                content.appendChild(iframe);
                preloadedIframes[app] = iframe;
            }

            iframesInitialized = true;
        }

        function updateEmbeddedPage(app) {
            const header = document.getElementById('embeddedHeader');
            const content = document.getElementById('embeddedContent');

            if (app === 'forum') {
                header.textContent = '总教练 - 多智能体协同 · 训练方案统筹';
                Object.values(preloadedIframes).forEach(iframe => iframe.style.display = 'none');
                content.querySelector('.status-placeholder')?.remove();
                document.getElementById('forumContainer').classList.add('active');
                document.getElementById('reportContainer').classList.remove('active');
                return;
            }

            if (app === 'report') {
                header.textContent = '训练秘书 - 报告生成汇总 · 数据可视化呈现';
                Object.values(preloadedIframes).forEach(iframe => iframe.style.display = 'none');
                content.querySelector('.status-placeholder')?.remove();
                document.getElementById('reportContainer').classList.add('active');
                document.getElementById('forumContainer').classList.remove('active');
                return;
            }

            document.getElementById('forumContainer').classList.remove('active');
            document.getElementById('reportContainer').classList.remove('active');
            header.textContent = agentTitles[app] || appNames[app] || app;

            if (appStatus[app] === 'running') {
                if (!iframesInitialized) preloadIframes();
                Object.values(preloadedIframes).forEach(iframe => iframe.style.display = 'none');
                content.querySelector('.status-placeholder')?.remove();
                if (preloadedIframes[app]) preloadedIframes[app].style.display = 'block';
            } else {
                Object.values(preloadedIframes).forEach(iframe => iframe.style.display = 'none');
                let placeholder = content.querySelector('.status-placeholder');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'status-placeholder';
                    placeholder.style.cssText = 'display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);flex-direction:column;position:absolute;top:0;left:0;width:100%;gap:12px;';
                    content.appendChild(placeholder);
                }
                placeholder.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.4">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <div>${appNames[app]} 未运行</div>
                    <div style="font-size:12px;opacity:0.7;">状态: ${appStatus[app]}</div>
                `;
            }
        }

        function checkStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => updateAppStatus(data))
            .catch(error => console.error('状态检查失败:', error));
        }

        function updateAppStatus(data) {
            for (const [app, info] of Object.entries(data)) {
                const status = info.status === 'running' ? 'running' : 'stopped';
                appStatus[app] = status;

                const indicator = document.getElementById(`status-${app}`);
                if (indicator) indicator.className = `status-indicator ${status}`;
            }
            updateEmbeddedPage(currentApp);
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function updateTime() {
            document.getElementById('systemTime').textContent = new Date().toLocaleTimeString('zh-CN');
        }

        function showMessage(text, type = 'info') {
            const message = document.getElementById('message');
            if (message.hideTimer) clearTimeout(message.hideTimer);

            message.textContent = text;
            message.className = `message ${type}`;
            message.classList.add('show');

            message.hideTimer = setTimeout(() => {
                message.classList.remove('show');
                setTimeout(() => {
                    message.textContent = '';
                    message.className = 'message';
                }, 300);
            }, 3000);
        }

        function handleTemplateUpload(event) {
            const file = event.target.files[0];
            const statusDiv = document.getElementById('uploadStatus');

            if (!file) {
                statusDiv.textContent = '';
                statusDiv.className = 'upload-status';
                customTemplate = '';
                return;
            }

            const fileName = file.name.toLowerCase();
            const isValidType = fileName.endsWith('.md') || fileName.endsWith('.txt');

            if (!isValidType) {
                statusDiv.textContent = '错误: 请选择 .md 或 .txt 文件';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = '';
                return;
            }

            if (file.size > 1024 * 1024) {
                statusDiv.textContent = '错误: 文件大小不能超过 1MB';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = '';
                return;
            }

            statusDiv.textContent = '正在读取文件...';
            statusDiv.className = 'upload-status';

            const reader = new FileReader();
            reader.onload = function(e) {
                customTemplate = e.target.result;
                statusDiv.textContent = `已加载: ${file.name}`;
                statusDiv.className = 'upload-status success';
                showMessage(`自定义模板已加载: ${file.name}`, 'success');
            };

            reader.onerror = function() {
                statusDiv.textContent = '错误: 文件读取失败';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = '';
            };

            reader.readAsText(file, 'utf-8');
        }

        // Forum Engine
        let forumLogLineCount = 0;
        let reportLogLineCount = 0;
        let reportLockCheckInterval = null;

        function refreshForumMessages() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > forumLogLineCount) {
                    const newLines = data.log_lines.slice(forumLogLineCount);
                    newLines.forEach(line => {
                        const parsed = parseForumMessage(line);
                        if (parsed) addForumMessage(parsed);
                    });
                    forumLogLineCount = data.log_lines.length;
                }
            })
            .catch(error => console.error('刷新论坛消息失败:', error));
        }

        function initializeForum() {
            refreshForumMessages();
        }

        function loadForumLog() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const chatArea = document.getElementById('forumChatArea');
                    chatArea.innerHTML += `
                        <div class="forum-message system">
                            <div class="forum-message-header">SYSTEM</div>
                            <div class="forum-message-content">ForumEngine 论坛已启动</div>
                            <div class="forum-timestamp">${new Date().toLocaleTimeString('zh-CN')}</div>
                        </div>
                    `;

                    const consoleOutput = document.getElementById('consoleOutput');
                    consoleOutput.innerHTML = '<div class="console-line">[系统] Forum Engine 日志输出</div>';

                    if (data.log_lines && data.log_lines.length > 0) {
                        data.log_lines.forEach(line => {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = line;
                            consoleOutput.appendChild(div);
                        });
                        forumLogLineCount = data.log_lines.length;
                    } else {
                        forumLogLineCount = 0;
                    }

                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => console.error('加载论坛日志失败:', error));
        }

        function refreshForumLog() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > forumLogLineCount) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    const newLines = data.log_lines.slice(forumLogLineCount);

                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);

                        const parsed = parseForumMessage(line);
                        if (parsed) addForumMessage(parsed);
                    });

                    forumLogLineCount = data.log_lines.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => console.error('刷新论坛日志失败:', error));
        }

        let autoGenerateTriggered = false;

        function checkReportLockStatus() {
            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                const reportButton = document.querySelector('[data-app="report"]');

                if (data.success && data.engines_ready) {
                    reportButton.classList.remove('locked');
                    reportButton.title = 'Report Engine - 所有引擎都有新文件，可以生成报告';

                    const reportPreview = document.getElementById('reportPreview');
                    const hasReport = reportPreview && reportPreview.querySelector('iframe');

                    if (currentApp === 'report' && !autoGenerateTriggered && !reportTaskId && !hasReport) {
                        autoGenerateTriggered = true;
                        setTimeout(() => generateReport(), 1000);
                    }
                } else {
                    reportButton.classList.add('locked');
                    let titleInfo = '\n';
                    if (data.missing_files && data.missing_files.length > 0) {
                        titleInfo += '等待新文件:\n' + data.missing_files.join('\n');
                    } else {
                        titleInfo += '等待三个Agent工作完毕';
                    }
                    reportButton.title = titleInfo;
                }
            })
            .catch(error => {
                console.error('检查Report Engine状态失败:', error);
                document.querySelector('[data-app="report"]').classList.add('locked');
            });
        }

        function refreshReportLog() {
            fetch('/api/report/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > reportLogLineCount) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    const newLines = data.log_lines.slice(reportLogLineCount);

                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);
                    });

                    reportLogLineCount = data.log_lines.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => console.error('刷新Report日志失败:', error));
        }

        function loadReportLog() {
            fetch('/api/report/log')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    consoleOutput.innerHTML = '<div class="console-line">[系统] Report Engine 日志监控已启动</div>';

                    if (data.log_lines && data.log_lines.length > 0) {
                        data.log_lines.forEach(line => {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = line;
                            consoleOutput.appendChild(div);
                        });
                        reportLogLineCount = data.log_lines.length;
                    } else {
                        reportLogLineCount = 0;
                    }

                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => console.error('加载Report日志失败:', error));
        }

        function parseForumMessage(logLine) {
            try {
                const timeMatch = logLine.match(/^\[(\d{2}:\d{2}:\d{2})\]/);
                if (!timeMatch) return null;

                const timestamp = timeMatch[1];
                const restContent = logLine.substring(timeMatch[0].length).trim();

                const sourceMatch = restContent.match(/^\[([^\]]+)\]\s*(.*)$/);
                if (!sourceMatch) return null;

                const source = sourceMatch[1];
                const content = sourceMatch[2];

                if (!['QUERY', 'INSIGHT', 'MEDIA', 'HOST'].includes(source.toUpperCase()) ||
                    !content || content.includes('=== ForumEngine')) {
                    return null;
                }

                let messageType = 'agent';
                let displayName = '';

                switch(source.toUpperCase()) {
                    case 'INSIGHT': displayName = '运动科学家'; break;
                    case 'MEDIA': displayName = '后勤与情报官'; break;
                    case 'QUERY': displayName = '理论专家'; break;
                    case 'HOST': messageType = 'host'; displayName = '总教练'; break;
                }

                return {
                    type: messageType,
                    source: displayName,
                    content: content.replace(/\\n/g, '\n').replace(/\\r/g, ''),
                    timestamp: timestamp
                };

            } catch (error) {
                return null;
            }
        }

        function addForumMessage(data) {
            const chatArea = document.getElementById('forumChatArea');
            const messageDiv = document.createElement('div');

            const messageType = data.type || 'system';
            messageDiv.className = `forum-message ${messageType}`;

            if (data.source) {
                const sourceClass = data.source.toLowerCase().replace(/\s+/g, '-');
                messageDiv.classList.add(sourceClass);

                if (data.source.toLowerCase().includes('query')) {
                    messageDiv.classList.add('query-engine');
                } else if (data.source.toLowerCase().includes('scientist')) {
                    messageDiv.classList.add('insight-engine');
                } else if (data.source.toLowerCase().includes('情报')) {
                    messageDiv.classList.add('media-engine');
                } else if (data.source.toLowerCase().includes('host')) {
                    messageDiv.classList.add('host');
                }
            }

            messageDiv.innerHTML = `
                <div class="forum-message-header">${data.sender || data.source || getMessageHeader(messageType)}</div>
                <div class="forum-message-content">${escapeHtml(data.content)}</div>
                <div class="forum-timestamp">${data.timestamp || new Date().toLocaleTimeString('zh-CN')}</div>
            `;

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function getMessageHeader(type) {
            const headers = { user: '用户', agent: 'AI助手', system: '系统', host: '论坛主持人' };
            return headers[type] || '未知';
        }

        // Report Engine
        let reportTaskId = null;
        let reportPollingInterval = null;

        function loadReportInterface() {
            const reportContent = document.getElementById('reportContent');

            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const indicator = document.getElementById('status-report');
                    if (indicator) {
                        indicator.className = data.initialized ? 'status-indicator running' : 'status-indicator';
                        appStatus.report = data.initialized ? 'running' : 'stopped';
                    }
                    renderReportInterface(data);
                } else {
                    reportContent.innerHTML = `<div class="report-status error"><strong>错误:</strong> ${data.error}</div>`;
                }
            })
            .catch(error => {
                reportContent.innerHTML = `<div class="report-status error"><strong>加载失败:</strong> ${error.message}</div>`;
            });
        }

        function renderReportInterface(statusData) {
            const reportContent = document.getElementById('reportContent');

            reportContent.innerHTML = `
                <div class="engine-status-info" id="engineStatusBlock">
                    <div class="report-status" id="engineStatusContent">
                        <div>正在初始化...</div>
                    </div>
                </div>
                <div id="taskProgressArea"></div>
                <div class="report-preview" id="reportPreview">
                    <div class="report-loading">等待生成训练分析报告</div>
                </div>
            `;

            updateEngineStatusDisplay(statusData);

            if (statusData.current_task) {
                const taskArea = document.getElementById('taskProgressArea');
                if (taskArea) taskArea.innerHTML = renderTaskStatus(statusData.current_task);
            }
        }

        function renderTaskStatus(task) {
            const statusText = { running: '正在生成', completed: '已完成', error: '生成失败', pending: '等待中' };
            const loadingIndicator = task.status !== 'completed' && task.status !== 'error' ? '<span class="report-loading-spinner"></span>' : '';

            return `
                <div class="task-progress-container">
                    <div class="task-progress-header">
                        <div class="task-progress-title">${loadingIndicator}报告生成任务</div>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${Math.min(Math.max(task.progress || 0, 0), 100)}%"></div>
                            <div class="task-progress-text">${task.progress || 0}%</div>
                        </div>
                    </div>
                    <div class="task-info-line">
                        <div class="task-info-item"><span class="task-info-label">任务ID:</span><span class="task-info-value">${task.task_id}</span></div>
                        <div class="task-info-item"><span class="task-info-label">查询:</span><span class="task-info-value">${task.query}</span></div>
                        <div class="task-info-item"><span class="task-info-label">开始:</span><span class="task-info-value">${new Date(task.created_at).toLocaleString()}</span></div>
                    </div>
                    ${task.error_message ? `<div class="task-error-message"><strong>错误:</strong> ${task.error_message}</div>` : ''}
                </div>
            `;
        }

        function generateReport() {
            const query = document.getElementById('searchInput').value.trim() || '训练数据综合分析报告';

            reportLogLineCount = 0;
            document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[系统] 开始生成报告</div>';
            addTaskProgressStatus('正在启动报告生成任务...', 'loading');

            const requestData = { query };
            if (customTemplate && customTemplate.trim()) requestData.custom_template = customTemplate;

            fetch('/api/report/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    reportTaskId = data.task_id;
                    showMessage('报告生成已启动', 'success');
                    updateTaskProgressStatus({
                        task_id: data.task_id,
                        query: query,
                        status: 'running',
                        progress: 5,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    setTimeout(() => refreshReportLog(), 500);
                    startProgressPolling(data.task_id);
                } else {
                    updateTaskProgressStatus(null, 'error', '启动失败: ' + data.error);
                    autoGenerateTriggered = false;
                    reportTaskId = null;
                }
            })
            .catch(error => {
                updateTaskProgressStatus(null, 'error', '生成报告失败: ' + error.message);
                autoGenerateTriggered = false;
                reportTaskId = null;
            });
        }

        function startProgressPolling(taskId) {
            if (reportPollingInterval) clearInterval(reportPollingInterval);
            reportPollingInterval = setInterval(() => checkTaskProgress(taskId), 2000);
        }

        function checkTaskProgress(taskId) {
            fetch(`/api/report/progress/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProgressDisplay(data.task);
                    refreshReportLog();

                    if (data.task.status === 'completed') {
                        clearInterval(reportPollingInterval);
                        showMessage('报告生成完成！', 'success');
                        viewReport(taskId);
                        autoGenerateTriggered = false;
                        reportTaskId = null;
                    } else if (data.task.status === 'error') {
                        clearInterval(reportPollingInterval);
                        showMessage('报告生成失败: ' + data.task.error_message, 'error');
                        autoGenerateTriggered = false;
                        reportTaskId = null;
                    }
                }
            })
            .catch(error => console.error('检查进度失败:', error));
        }

        function addTaskProgressStatus(message, status) {
            const taskArea = document.getElementById('taskProgressArea');
            if (taskArea) {
                const loadingIndicator = status === 'loading' ? '<span class="report-loading-spinner"></span>' : '';
                taskArea.innerHTML = `<div class="task-progress-container"><div class="task-progress-header">${loadingIndicator}任务状态: ${message}</div></div>`;
            }
        }

        function updateTaskProgressStatus(task, status = null, errorMessage = null) {
            const taskArea = document.getElementById('taskProgressArea');
            if (!taskArea) return;

            if (task) {
                taskArea.innerHTML = renderTaskStatus(task);
            } else if (status && errorMessage) {
                const loadingIndicator = status === 'loading' ? '<span class="report-loading-spinner"></span>' : '';
                taskArea.innerHTML = `
                    <div class="task-progress-container">
                        <div class="task-progress-header">${loadingIndicator}任务状态: ${status === 'error' ? '错误' : '处理中'}</div>
                        <div style="margin-top:10px;font-size:14px;">${errorMessage}</div>
                    </div>
                `;
            }
        }

        function updateProgressDisplay(task) {
            updateTaskProgressStatus(task);
        }

        function viewReport(taskId) {
            const reportPreview = document.getElementById('reportPreview');
            reportPreview.innerHTML = '<div class="report-loading"><span class="report-loading-spinner"></span>加载报告中...</div>';

            fetch(`/api/report/result/${taskId}`)
            .then(response => {
                if (!response.ok) throw new Error('报告加载失败');
                return response.text();
            })
            .then(rawContent => {
                let htmlContent = rawContent;

                try {
                    if (rawContent.includes('"html_content":')) {
                        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const jsonData = JSON.parse(jsonMatch[0]);
                            if (jsonData.html_content) {
                                htmlContent = jsonData.html_content.replace(/\\"/g, '"').replace(/\\n/g, '\n');
                            }
                        }
                    }
                } catch (e) {
                    console.warn('解析JSON格式报告失败，使用原始内容');
                }

                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'width:100%;border:none;min-height:800px;overflow:hidden;';
                iframe.scrolling = 'no';
                iframe.id = 'report-iframe';

                reportPreview.innerHTML = '';
                reportPreview.appendChild(iframe);

                iframe.contentDocument.open();
                iframe.contentDocument.write(htmlContent);
                iframe.contentDocument.close();

                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc) {
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                        body { color: #e5e7eb !important; background-color: #1a1a1a !important; line-height: 1.7; font-size: 15px; }
                        h1, h2, h3, h4, h5, h6 { color: #f3f4f6 !important; font-weight: 600; margin-top: 1.5em; margin-bottom: 0.8em; }
                        h1 { font-size: 2em; border-bottom: 2px solid #374151; padding-bottom: 0.3em; }
                        h2 { font-size: 1.6em; border-bottom: 1px solid #374151; padding-bottom: 0.2em; }
                        p, li, td, th, div { color: #d1d5db !important; }
                        a { color: #60a5fa !important; text-decoration: underline; }
                        a:hover { color: #93c5fd !important; }
                        code, pre { background-color: #1f2937 !important; color: #fbbf24 !important; border: 1px solid #374151; border-radius: 4px; }
                        pre { padding: 1em; overflow-x: auto; }
                        code { padding: 0.2em 0.4em; font-size: 0.9em; }
                        table { border-collapse: collapse; width: 100%; margin: 1em 0; }
                        th { background-color: #1f2937 !important; color: #f3f4f6 !important; font-weight: 600; padding: 0.8em; border: 1px solid #374151; }
                        td { padding: 0.8em; border: 1px solid #374151; color: #d1d5db !important; }
                        tr:nth-child(even) { background-color: #1f2937; }
                        ul, ol { padding-left: 2em; margin: 1em 0; }
                        li { margin: 0.5em 0; }
                        blockquote { border-left: 4px solid #60a5fa; padding-left: 1em; margin: 1em 0; color: #9ca3af !important; font-style: italic; }
                        hr { border: none; border-top: 2px solid #374151; margin: 2em 0; }
                        strong, b { color: #fbbf24 !important; font-weight: 600; }
                        em, i { color: #a78bfa !important; }
                    `;
                    iframeDoc.head.appendChild(style);
                }

                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            const doc = iframe.contentDocument || iframe.contentWindow.document;
                            let h = Math.max(doc.body?.scrollHeight || 0, doc.body?.offsetHeight || 0, doc.documentElement?.scrollHeight || 0);
                            iframe.style.height = Math.max(h + 100, 800) + 'px';
                            reportPreview.style.minHeight = iframe.style.height;
                        } catch (e) {
                            iframe.style.height = '1200px';
                        }
                    }, 1000);
                };

                setTimeout(() => {
                    if (!iframe.style.height || iframe.style.height === 'auto') iframe.style.height = '1200px';
                }, 3000);
            })
            .catch(error => {
                reportPreview.innerHTML = `<div class="report-loading">报告加载失败: ${error.message}</div>`;
            });
        }

        function checkReportStatus() {
            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const indicator = document.getElementById('status-report');
                    if (indicator) {
                        indicator.className = data.initialized ? 'status-indicator running' : 'status-indicator';
                        appStatus.report = data.initialized ? 'running' : 'stopped';
                    }
                    updateEngineStatusDisplay(data);
                    showMessage('状态检查完成', 'success');
                } else {
                    showMessage('状态检查失败: ' + data.error, 'error');
                }
            })
            .catch(error => showMessage('状态检查失败: ' + error.message, 'error'));
        }

        function updateEngineStatusDisplay(statusData) {
            const statusContent = document.getElementById('engineStatusContent');
            if (statusContent) {
                const statusClass = statusData.initialized ? 'success' : 'error';
                let statusHTML = statusData.initialized ? `
                    <strong>ReportEngine状态:</strong> 已初始化<br>
                    <strong>文件检查:</strong> ${statusData.engines_ready ? '准备就绪' : '文件未就绪'}<br>
                    <strong>找到文件:</strong> ${statusData.files_found ? statusData.files_found.join(', ') : '无'}<br>
                    ${statusData.missing_files?.length > 0 ? `<strong>缺失文件:</strong> ${statusData.missing_files.join(', ')}` : ''}
                ` : `<strong>ReportEngine状态:</strong> 未初始化`;

                statusContent.innerHTML = statusHTML;
                statusContent.className = `report-status ${statusClass}`;
            }
        }
    </script>
</body>
</html>
